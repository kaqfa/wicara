{% extends "admin/base.html" %}

{% block title %}Dashboard{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block content %}
<!-- Statistics Overview -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-number">{{ pages|length }}</div>
        <div class="stat-label">Total Pages</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ pages|map(attribute='fields')|map('length')|sum }}</div>
        <div class="stat-label">Total Fields</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ keywords|length }}</div>
        <div class="stat-label">Keywords</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ description|length if description else 0 }}</div>
        <div class="stat-label">Description Chars</div>
    </div>
</div>

<!-- Pages Table -->
<div class="table-container">
    <div class="table-header">
        <h2>Pages Management</h2>
        <div class="table-actions">
            <input type="text" id="tableSearch" placeholder="Search pages..." class="search-input">
            <select id="tablePerPage" class="per-page-select">
                <option value="10">10 per page</option>
                <option value="25">25 per page</option>
                <option value="50">50 per page</option>
                <option value="100">100 per page</option>
            </select>
            <a href="{{ url_for('admin.settings') }}" class="btn-primary">
                <i class="bi bi-plus-lg"></i>
                Add Page
            </a>
        </div>
    </div>

    <div class="table-wrapper">
        <table class="modern-table" id="pagesTable">
            <thead>
                <tr>
                    <th class="checkbox-col">
                        <input type="checkbox" id="selectAll">
                    </th>
                    <th class="sortable" data-sort="title">
                        Page Title <i class="bi bi-arrow-down-up sort-icon"></i>
                    </th>
                    <th class="sortable" data-sort="url">
                        URL <i class="bi bi-arrow-down-up sort-icon"></i>
                    </th>
                    <th>Template</th>
                    <th>Fields</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody id="pagesTableBody">
                {% for page in pages %}
                <tr data-page-id="{{ loop.index0 }}" data-title="{{ page.get('menu-title', page['title'])|lower }}" data-url="{{ page['url']|lower }}">
                    <td><input type="checkbox" class="row-checkbox" data-page-id="{{ loop.index0 }}"></td>
                    <td>
                        <span class="page-title">{{ page.get('menu-title', page['title']) }}</span>
                        {% if page.get('seo-description') %}
                        <span class="page-seo">{{ page.get('seo-description')[:60] }}{% if page.get('seo-description')|length > 60 %}...{% endif %}</span>
                        {% endif %}
                    </td>
                    <td><code class="url-badge">{{ page['url'] }}</code></td>
                    <td><span class="template-badge">{{ page['template'] }}</span></td>
                    <td><span class="date-badge">{{ page['fields']|length }} fields</span></td>
                    <td class="text-center">
                        <div class="action-buttons">
                            <a href="{{ url_for('admin.edit_page', page_index=loop.index0) }}"
                               class="btn-icon" title="Edit Page">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <a href="{{ url_for('public.index') }}{{ page['url'] }}"
                               target="_blank" class="btn-icon" title="View Page">
                                <i class="bi bi-eye"></i>
                            </a>
                            <button class="btn-icon btn-delete" title="Delete Page"
                                    data-page-url="{{ page['url'] }}" data-page-title="{{ page.get('menu-title', page['title']) }}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="table-pagination">
        <button class="btn-page" id="prevPage" disabled>
            <i class="bi bi-chevron-left"></i> Previous
        </button>
        <span class="page-info" id="pageInfo">Showing 1-{{ [pages|length, 10]|min }} of {{ pages|length }}</span>
        <button class="btn-page" id="nextPage" {% if pages|length <= 10 %}disabled{% endif %}>
            Next <i class="bi bi-chevron-right"></i>
        </button>
    </div>
</div>

<!-- Quick Actions -->
<div class="stats-grid" style="margin-top: 2rem; margin-bottom: 0;">
    <a href="{{ url_for('admin.settings') }}" class="stat-card" style="text-decoration: none; display: block;">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <i class="bi bi-gear" style="font-size: 2rem; color: var(--accent-primary);"></i>
            <div>
                <div style="font-weight: 600; color: var(--text-primary);">Site Settings</div>
                <div style="font-size: 0.875rem; color: var(--text-secondary);">Configure site information</div>
            </div>
        </div>
    </a>
    <a href="{{ url_for('admin.change_password') }}" class="stat-card" style="text-decoration: none; display: block;">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <i class="bi bi-key" style="font-size: 2rem; color: var(--info);"></i>
            <div>
                <div style="font-weight: 600; color: var(--text-primary);">Change Password</div>
                <div style="font-size: 0.875rem; color: var(--text-secondary);">Update admin password</div>
            </div>
        </div>
    </a>
    <a href="{{ url_for('cache.cache_dashboard') }}" class="stat-card" style="text-decoration: none; display: block;">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <i class="bi bi-hdd-network" style="font-size: 2rem; color: var(--success);"></i>
            <div>
                <div style="font-weight: 600; color: var(--text-primary);">Cache Dashboard</div>
                <div style="font-size: 0.875rem; color: var(--text-secondary);">Manage cache settings</div>
            </div>
        </div>
    </a>
    <a href="{{ url_for('import_export.export_page') }}" class="stat-card" style="text-decoration: none; display: block;">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <i class="bi bi-arrow-left-right" style="font-size: 2rem; color: var(--warning);"></i>
            <div>
                <div style="font-weight: 600; color: var(--text-primary);">Import/Export</div>
                <div style="font-size: 0.875rem; color: var(--text-secondary);">Backup or restore site</div>
            </div>
        </div>
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Table state
let currentPage = 1;
let rowsPerPage = 10;
let currentSort = { column: null, direction: 'asc' };
let filteredRows = [];

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    const tableBody = document.getElementById('pagesTableBody');
    const allRows = Array.from(tableBody.querySelectorAll('tr'));
    filteredRows = allRows;

    // Search functionality
    const searchInput = document.getElementById('tableSearch');
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        filteredRows = allRows.filter(row => {
            const title = row.dataset.title || '';
            const url = row.dataset.url || '';
            return title.includes(searchTerm) || url.includes(searchTerm);
        });
        currentPage = 1;
        renderTable();
    });

    // Rows per page
    const perPageSelect = document.getElementById('tablePerPage');
    perPageSelect.addEventListener('change', function() {
        rowsPerPage = parseInt(this.value);
        currentPage = 1;
        renderTable();
    });

    // Pagination
    document.getElementById('prevPage').addEventListener('click', function() {
        if (currentPage > 1) {
            currentPage--;
            renderTable();
        }
    });

    document.getElementById('nextPage').addEventListener('click', function() {
        const maxPage = Math.ceil(filteredRows.length / rowsPerPage);
        if (currentPage < maxPage) {
            currentPage++;
            renderTable();
        }
    });

    // Select all checkbox
    document.getElementById('selectAll').addEventListener('change', function() {
        const checkboxes = tableBody.querySelectorAll('.row-checkbox');
        checkboxes.forEach(cb => {
            if (cb.closest('tr').style.display !== 'none') {
                cb.checked = this.checked;
            }
        }, this);
    });

    // Sorting
    document.querySelectorAll('.sortable').forEach(th => {
        th.addEventListener('click', function() {
            const sortBy = this.dataset.sort;
            const icon = this.querySelector('.sort-icon');

            // Reset other icons
            document.querySelectorAll('.sort-icon').forEach(i => {
                if (i !== icon) {
                    i.className = 'bi bi-arrow-down-up sort-icon';
                }
            });

            // Toggle direction
            if (currentSort.column === sortBy) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = sortBy;
                currentSort.direction = 'asc';
            }

            // Update icon
            icon.className = currentSort.direction === 'asc'
                ? 'bi bi-arrow-up sort-icon'
                : 'bi bi-arrow-down sort-icon';

            // Sort rows
            filteredRows.sort((a, b) => {
                let aVal = a.dataset[sortBy];
                let bVal = b.dataset[sortBy];

                if (currentSort.direction === 'asc') {
                    return aVal.localeCompare(bVal);
                } else {
                    return bVal.localeCompare(aVal);
                }
            });

            renderTable();
        });
    });

    // Delete button handling
    document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', function() {
            const pageUrl = this.dataset.pageUrl;
            const pageTitle = this.dataset.pageTitle;

            if (confirm(`Are you sure you want to delete "${pageTitle}"?\n\nURL: ${pageUrl}`)) {
                // In a real app, you would make an AJAX call here
                // For now, just remove the row visually
                const row = this.closest('tr');
                row.style.opacity = '0.5';
                setTimeout(() => {
                    window.location.href = `/admin/delete-page/${pageUrl}`;
                }, 300);
            }
        });
    });

    // Initial render
    renderTable();
});

function renderTable() {
    const tableBody = document.getElementById('pagesTableBody');
    const allRows = Array.from(tableBody.querySelectorAll('tr'));

    // Hide all rows first
    allRows.forEach(row => row.style.display = 'none');

    // Calculate pagination
    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const visibleRows = filteredRows.slice(start, end);

    // Show filtered rows for current page
    visibleRows.forEach(row => {
        row.style.display = '';
    });

    // Update page info
    const totalRows = filteredRows.length;
    const showStart = totalRows === 0 ? 0 : start + 1;
    const showEnd = Math.min(end, totalRows);
    document.getElementById('pageInfo').textContent =
        `Showing ${showStart}-${showEnd} of ${totalRows}`;

    // Update pagination buttons
    document.getElementById('prevPage').disabled = currentPage === 1;
    document.getElementById('nextPage').disabled = end >= totalRows;

    // Uncheck select all if no rows are selected
    if (start === 0) {
        document.getElementById('selectAll').checked = false;
    }
}
</script>
{% endblock %}
